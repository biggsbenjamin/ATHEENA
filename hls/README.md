# ATHEENA (and fpgaConvNet) HLS

This is CNN-to-FPGA mapping framework designed to find the optimal implementation of a CNN architecture on an FPGA for power, latency and throughput driven designs.

## Setup

_This project has only been verified on Ubuntu 20.04_

The following programmes are needed:

1. Vivado 2019.1 (with y2k patch)
2. yaml-cpp (version 0.5.3)

This uses the same python environment as the optimiser.

### Vivado setup

To install Vivado 2019.1:

1. First [download](https://www.xilinx.com/support/download/index.html/content/xilinx/en/downloadNav/vivado-design-tools/2019-1.html) from the Xilinx website.

2. Install the y2k22 patch according to these [instructions](https://support.xilinx.com/s/article/76960?language=en_US).

3. Add the following to your ~/.bashrc file:

```
export PATH=/tools/Xilinx/Vivado/2019.1/bin:$PATH
export PATH=/tools/Xilinx/SDK/2019.1/bin:$PATH
export FPGACONVNET_ROOT=(path to repo)/ATHEENA_fccm_artifacts/hls
export FPGACONVNET_HLS=(path to repo)/ATHEENA_fccm_artifacts/hls
export FPGACONVNET_OPTIMISER=(path to repo)/ATHEENA_fccm_artifacts/optimiser
```

4. Once installed, you will also need to add a license server to your .bashrc file.

5. You will need to setup JTAG drivers to program a device. To do so, execute the following script:

```
/tools/Xilinx/Vivado/2019.1/data/xicom/cable_drivers/lin64/install_script/install_drivers/install_drivers
```

For more information, visit [here](https://www.xilinx.com/support/answers/59128.html).

Finally, there is a known [bug](http://svn.clifford.at/handicraft/2017/vivadobugs/vivadobug04.txt) to do with C++ libraries. A workaround for this is adding the `mpfr.h` and `gmp.h` headers manually. For this project, you need to create a header file `include/system.hpp` which includes the following:

```C
#ifndef SYSTEM_HPP_
#define SYSTEM_HPP_

#include "(path to Vivado 2019.1)/include/gmp.h"
#include "(path to Vivado 2019.1)/include/mpfr.h"

#endif
```

### Example Test Project

We have included an example HLS project for the artifact review. To run the HLS generation for this example (branchy lenet):

```
cd ./test/partitions/arti_test_brn

./split_run.sh -a
```

This will run the HLS compilation for the layers specified in the .json file in this folder (this will take a while).
> **Note** More detailed instructions on how to include the buffer uploaded shortly.

To run your own version, copy the json file generated by the optimiser after the merge stage into a new folder in `./test/partitions/(example)`.
Navigate to `./test/partitions/` and run `./../../scripts/split_run.sh -a -v`.

This should run through the HLS component generation, stitch the components in a Vivado project, run sythesis and place and route, and generate the host code needed to run bitstream.
