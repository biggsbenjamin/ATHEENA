# ATHEENA (and fpgaConvNet) HLS

This is CNN-to-FPGA mapping framework designed to find the optimal implementation of a CNN architecture on an FPGA for power, latency and throughput driven designs.

## Setup

_This project has only been verified on Ubuntu 20.04_

The following programmes are needed:

1. Vivado 2019.1 (with y2k patch)
2. yaml-cpp (version 0.5.3)
3. Conda ver. 4.10

Add the environmental variable `FPGACONVNET_OPTIMISER` that points to the `optimiser` directory of this repository.
Add the environmental variable `FPGACONVNET_HLS` that points to this directory.
Add the environmental variable `FPGACONVNET_ROOT` that points to this directory.

This uses the same python environment as the optimiser.

### Vivado Setup

To install Vivado 2019.1, first [download](https://www.xilinx.com/support/download/index.html/content/xilinx/en/downloadNav/vivado-design-tools/2019-1.html) from the Xilinx website.

Once installed, you will need to add a license server to your .bashrc file. You will also need to add Vivado to your path. To do so, add the following to your .basrc:

```
export PATH=/tools/Xilinx/Vivado/2019.1/bin:$PATH
export PATH=/tools/Xilinx/SDK/2019.1/bin:$PATH
```

You will need to setup JTAG drivers to program a device. To do so, execute the following script:

```
/tools/Xilinx/Vivado/2019.1/data/xicom/cable_drivers/lin64/install_script/install_drivers/install_drivers
```

For more information, visit [here](https://www.xilinx.com/support/answers/59128.html).

Finally, there is a known [bug](http://svn.clifford.at/handicraft/2017/vivadobugs/vivadobug04.txt) to do with C++ libraries. A workaround for this is adding the `mpfr.h` and `gmp.h` headers manually. For this project, you need to create a header file `include/system.hpp` which includes the following:

```C
#ifndef SYSTEM_HPP_
#define SYSTEM_HPP_

#include "(path to Vivado 2019.1)/include/gmp.h"
#include "(path to Vivado 2019.1)/include/mpfr.h"

#endif
```

### Example Test Project

We have included an example HLS project for the artifact review. To run the HLS generation for this example (branchy lenet):

```
cd ./test/partitions/arti_test_brn

./split_run.sh -a
```

This will run the HLS compilation for the layers specified in the .json file in this folder (this will take a while).
> **Note** More detailed instructions on how to include the buffer uploaded shortly.

To run your own version, copy the json file generated by the optimiser after the merge stage into a new folder in `./test/partitions/(example)`.
Copy the `split_run.sh` script into this new folder (example) and run `./split_run.sh -a`.
